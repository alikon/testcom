name: CI Alikonweb extensions Playground

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DB_NAME: test_joomla
  DB_USER: joomla_ut
  DB_PASS: joomla_ut

jobs:
# -------------------------------------------------
# Composer
# -------------------------------------------------
  composer:
    runs-on: ubuntu-latest
    container:
      image: joomlaprojects/docker-images:php8.3
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-dependencies

# -------------------------------------------------
# PHPCS (non-blocking)
# -------------------------------------------------
  phpcs:
    runs-on: ubuntu-latest
    needs: composer
    container:
      image: joomlaprojects/docker-images:php8.3
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-dependencies
      - name: Run PHP CS Fixer and PHPCS
        continue-on-error: true
        run: |
          ./vendor/bin/php-cs-fixer fix -vvv --dry-run --diff
          ./vendor/bin/phpcs --extensions=php -p --standard=ruleset.xml src/

# -------------------------------------------------
# NPM
# -------------------------------------------------
  npm:
    runs-on: ubuntu-latest
    needs: phpcs
    container:
      image: joomlaprojects/docker-images:php8.3
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-dependencies
        with:
          npm-cache: 'true'

# -------------------------------------------------
# PREPARE TESTS (Joomla versions)
# -------------------------------------------------
  prepare_tests:
    runs-on: ubuntu-latest
    needs: npm
    strategy:
      matrix:
        joomla-version: ['5.4', '6.0', '6.1']
    container:
      image: joomlaprojects/docker-images:cypress8.3
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-dependencies
        with:
          npm-cache: 'true'

      - uses: ./.github/actions/setup-cypress

      - name: Install jq
        run: apt-get update && apt-get install -y jq

      - name: Determine Nightly URL for Joomla ${{ matrix.joomla-version }}
        id: joomla-info
        shell: bash
        run: |
          URL=$(
            curl -s "https://api.github.com/repos/joomla/joomla-cms/releases" \
            | jq -r --arg ver "${{ matrix.joomla-version }}" '
                .[]
                | .assets[]
                | select(
                    .browser_download_url
                    | contains($ver)
                    and endswith("Full_Package.zip")
                  )
                | .browser_download_url
              ' \
            | head -1
          )

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "::error::Could not find URL for version ${{ matrix.joomla-version }}"
            exit 1
          fi

          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "url_hash=$(echo -n "$URL" | md5sum | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Cache Joomla Zip
        id: cache-joomla
        uses: actions/cache@v4
        with:
          path: joomla.zip
          key: joomla-core-${{ matrix.joomla-version }}-${{ steps.joomla-info.outputs.url_hash }}

      - name: Download Joomla
        if: steps.cache-joomla.outputs.cache-hit != 'true'
        run: |
          curl -LfsS "${{ steps.joomla-info.outputs.url }}" -o joomla.zip

      - name: Build and Verify
        run: |
          vendor/bin/robo build
          unzip -t joomla.zip > /dev/null

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-j${{ matrix.joomla-version }}
          path: |
            dist/
            joomla.zip
          retention-days: 1

# -------------------------------------------------
# PHPSTAN
# -------------------------------------------------
  phpstan:
    runs-on: ubuntu-latest
    needs: prepare_tests
    strategy:
      matrix:
        joomla-version: ['5.4', '6.0', '6.1']
    container:
      image: joomlaprojects/docker-images:php8.3
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts-j${{ matrix.joomla-version }}
      - uses: ./.github/actions/setup-dependencies
      - name: Run PHPStan
        continue-on-error: true
        run: |
          unzip -q joomla.zip -d joomla
          ./vendor/bin/phpstan analyse src --level=5 --no-progress

# -------------------------------------------------
# SYSTEM TESTS — MYSQL
# -------------------------------------------------
  system-tests-mysql:
    runs-on: ubuntu-latest
    needs: prepare_tests
    strategy:
      fail-fast: false
      matrix:
        joomla-version: ['5.4', '6.0', '6.1']
        php-version: ['8.2', '8.3']
    container:
      image: joomlaprojects/docker-images:cypress${{ matrix.php-version }}
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_joomla
          MYSQL_USER: joomla_ut
          MYSQL_PASSWORD: joomla_ut
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts-j${{ matrix.joomla-version }}
      - uses: ./.github/actions/setup-dependencies
      - uses: ./.github/actions/setup-cypress
      - name: Run MySQL system tests
        run: |
          unzip -q joomla.zip -d joomla
          cp cypress.config.dist.js cypress.config.js
          npx cypress run --browser chrome --e2e --config video=false

# -------------------------------------------------
# SYSTEM TESTS — MARIADB
# -------------------------------------------------
  system-tests-mariadb:
    runs-on: ubuntu-latest
    needs: prepare_tests
    strategy:
      fail-fast: false
      matrix:
        joomla-version: ['5.4', '6.0', '6.1']
        php-version: ['8.2', '8.3']
    container:
      image: joomlaprojects/docker-images:cypress${{ matrix.php-version }}
    services:
      mariadb:
        image: mariadb:10.6
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: test_joomla
          MARIADB_USER: joomla_ut
          MARIADB_PASSWORD: joomla_ut
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts-j${{ matrix.joomla-version }}
      - uses: ./.github/actions/setup-dependencies
      - uses: ./.github/actions/setup-cypress
      - name: Run MariaDB system tests
        run: |
          unzip -q joomla.zip -d joomla
          cp cypress.config.dist.js cypress.config.js
          npx cypress run --browser chrome --e2e --config video=false

# -------------------------------------------------
# SYSTEM TESTS — POSTGRES
# -------------------------------------------------
  system-tests-pgsql:
    runs-on: ubuntu-latest
    needs: prepare_tests
    strategy:
      fail-fast: false
      matrix:
        joomla-version: ['6.0', '6.1']
        php-version: ['8.3']
    container:
      image: joomlaprojects/docker-images:cypress${{ matrix.php-version }}
    services:
      postgres:
        image: postgres:12-alpine
        env:
          POSTGRES_DB: test_joomla
          POSTGRES_USER: root
          POSTGRES_PASSWORD: root
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts-j${{ matrix.joomla-version }}
      - uses: ./.github/actions/setup-dependencies
      - uses: ./.github/actions/setup-cypress
      - name: Run PostgreSQL system tests
        run: |
          unzip -q joomla.zip -d joomla
          cp cypress.config.dist.js cypress.config.js
          npx cypress run --browser chrome --e2e --config video=false
