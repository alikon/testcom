name: CI Alikonweb extensions Playground

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DB_NAME: test_joomla
  DB_USER: joomla_ut
  DB_PASS: joomla_ut

jobs:
# -------------------------------------------------
# Build jobs
# -------------------------------------------------
  composer:
    runs-on: ubuntu-latest
    container:
      image: joomlaprojects/docker-images:php8.3
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-dependencies

  phpcs:
    runs-on: ubuntu-latest
    needs: composer
    container:
      image: joomlaprojects/docker-images:php8.3
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-dependencies
      - run: |
          ./vendor/bin/php-cs-fixer fix -vvv --dry-run --diff
          ./vendor/bin/phpcs --extensions=php -p --standard=ruleset.xml src/

  npm:
    runs-on: ubuntu-latest
    needs: phpcs
    container:
      image: joomlaprojects/docker-images:php8.3
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-dependencies
        with:
          npm-cache: 'true'

  prepare_tests:
    runs-on: ubuntu-latest
    needs: npm
    strategy:
      matrix:
        joomla-version: ['5.4', '6.0', '6.1']
    container:
      image: joomlaprojects/docker-images:cypress8.3
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-dependencies
        with:
          npm-cache: 'true'
      - uses: ./.github/actions/setup-cypress
      - run: vendor/bin/robo build
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-j${{ matrix.joomla-version }}
          path: |
            dist/
            joomla.zip
          retention-days: 1

# -------------------------------------------------
# SYSTEM TESTS — MYSQL
# -------------------------------------------------
  system-tests-mysql:
    runs-on: ubuntu-latest
    needs: prepare_tests
    strategy:
      fail-fast: false
      matrix:
        joomla-version: ['5.4', '6.0', '6.1']
        php-version: ['8.2', '8.3']
        exclude:
          - joomla-version: '5.4'
            php-version: '8.3'

    container:
      image: joomlaprojects/docker-images:cypress${{ matrix.php-version }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_joomla
          MYSQL_USER: joomla_ut
          MYSQL_PASSWORD: joomla_ut
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts-j${{ matrix.joomla-version }}
      - uses: ./.github/actions/setup-dependencies
        with:
          npm-cache: 'true'
      - uses: ./.github/actions/setup-cypress

      - name: Run MySQL system tests
        run: |
          unzip -q joomla.zip -d joomla
          npx cypress run \
            --browser chrome \
            --e2e \
            --config video=false \
            --env cmsPath=/tests/www/mysql,db_type=mysqli,db_host=mysql,db_name=$DB_NAME,db_user=$DB_USER,db_password=$DB_PASS,db_prefix=mysql_

# -------------------------------------------------
# SYSTEM TESTS — MARIADB
# -------------------------------------------------
  system-tests-mariadb:
    runs-on: ubuntu-latest
    needs: prepare_tests
    strategy:
      fail-fast: false
      matrix:
        joomla-version: ['5.4', '6.0', '6.1']
        php-version: ['8.2', '8.3']

    container:
      image: joomlaprojects/docker-images:cypress${{ matrix.php-version }}

    services:
      mariadb:
        image: mariadb:10.6
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: test_joomla
          MARIADB_USER: joomla_ut
          MARIADB_PASSWORD: joomla_ut

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts-j${{ matrix.joomla-version }}
      - uses: ./.github/actions/setup-dependencies
      - uses: ./.github/actions/setup-cypress

      - name: Run MariaDB system tests
        run: |
          unzip -q joomla.zip -d joomla
          npx cypress run \
            --browser chrome \
            --e2e \
            --config video=false \
            --env cmsPath=/tests/www/mariadb,db_type=mysqli,db_host=mariadb,db_name=$DB_NAME,db_user=$DB_USER,db_password=$DB_PASS,db_prefix=mariadb_

# -------------------------------------------------
# SYSTEM TESTS — POSTGRES
# -------------------------------------------------
  system-tests-pgsql:
    runs-on: ubuntu-latest
    needs: prepare_tests
    strategy:
      fail-fast: false
      matrix:
        joomla-version: ['6.0', '6.1']
        php-version: ['8.3']

    container:
      image: joomlaprojects/docker-images:cypress${{ matrix.php-version }}

    services:
      postgres:
        image: postgres:12-alpine
        env:
          POSTGRES_DB: test_joomla
          POSTGRES_USER: root
          POSTGRES_PASSWORD: root

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts-j${{ matrix.joomla-version }}
      - uses: ./.github/actions/setup-dependencies
      - uses: ./.github/actions/setup-cypress

      - name: Run PostgreSQL system tests
        run: |
          unzip -q joomla.zip -d joomla
          npx cypress run \
            --browser chrome \
            --e2e \
            --config video=false \
            --env cmsPath=/tests/www/pgsql,db_type=pgsql,db_host=postgres,db_name=$DB_NAME,db_user=root,db_password=root,db_prefix=pgsql_
